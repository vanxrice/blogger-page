<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../core-animated-pages/core-animated-pages.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-toolbar/core-toolbar.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../polymer-jsonp/polymer-jsonp.html">

<script src="../time-elements/time-elements.js"></script>

<link rel="import" href="blogger-post.html">

<!--
A basic Polymer web component that fetches posts from Blogger over JSON.

Uses Blogger APIv3, which requires an API key. See Google's documentation on
how to obtain a Blogger API key (https://developers.google.com/blogger/docs/3.0/using#APIKey).

##### Example

    <blogger-page blogId="3730718121569395510" apiKey="AIzaSyBAsq-ZjBWJ9AdmX4QaxvoYovzqX-7_Yzg"
      contentPreviewMaxChars="140" maxPostCount="3"></blogger-page>

@element blogger-page
@blurb A basic Polymer web component that fetches a Blogger post list over JSON.
@status alpha
@homepage http://vanxrice.github.io/blogger-page
@demo http://vanxrice.github.io/blogger-page/demo.html
-->
<polymer-element name="blogger-page" attributes="blogId, apiKey, contentPreviewMaxChars, maxPostCount">
  <template is="auto binding">
    <style shim-shadowdom>
      :host {
        display: block;
        position: relative;
      }

      .card-container {
        top: 50px;
        right: 0;
        left: 0;
        text-align: center;
      }

      .card {
        margin: 0 10px 20px 10px;
        text-align: start;
        background-color: #fff;
        max-width: 280px;
        min-height: 200px;
      }

      .post-content {
        background-color: #fff;
        padding: 20px;
      }

      .italic {
        font-style: italic;
      }

      .white-icon {
        color: rgba(255,255,255,1);
      }

      .header-inverse {
        background-color: rgba(51,51,51,1);
        color: rgba(255,255,255,1);
        font-size: 20px;
        letter-spacing: 2px;
        margin-top: 0;
        margin-bottom: 0px;
      }
      
      .blogger-card-header {
        padding: 20px;
        padding-bottom: 2px;
      }

      .post-tags {
        padding-left: 20px;
        padding-right: 20px;
      }

      .post-tag {
        padding-right: 5px;
      }

      .text-body {
        font-size: 14px;
        font-weight: 400;
        line-height: 25px;
        padding-left: 20px;
        padding-right: 20px;
      }

      .text-subhead {
        font-size: 18px;
        font-weight: 600;
        line-height: 32px;
      }

      .weight-400 {
        font-weight: 400;
      }
    </style>

    <polymer-jsonp auto handleAs="json"
      url="https://www.googleapis.com/blogger/v3/blogs/{{blogId}}/posts?key={{apiKey}}&callback="
      response="{{response}}"
      on-polymer-response="{{onResponse}}">
    </polymer-jsonp>

    <!-- https://www.googleapis.com/blogger/v3/blogs/blogId/posts/postId&view=READER -->

    <template if="{{posts}}">
      <div flex>
        <core-animated-pages id="pages" flex selected="{{page}}" transitions="cross-fade-all hero-transition"
          on-core-animated-pages-transition-end="{{transitionend}}" on-core-animated-pages-transition-prepare="{{prepare}}">

          <section class="card-container" fit hero-p horizontal layout start wrap around-justified>
            <template repeat="{{post in posts}}">
              <paper-shadow z="2" class="card">
                <h1 class="header-inverse blogger-card-header">{{post.title}}</h1>
                <div>
                  <div class="post-tags" horizontal layout wrap>
                    <template repeat="{{post.labels as tag}}">
                      <div class="post-tag text-subhead">{{'#' + tag}}</div>
                    </template>
                  </div>
                  <div class="card-preview text-body">{{htmlToTextAndTrim(post.content)}}</div>
                  <div horizontal layout end>
                    <time flex class="text-body italic weight-400" is="relative-time" datetime="{{post.published}}"></time>
                    <paper-icon-button mini noink end icon="open-in-new" hero?="{{$.pages.selected === post.id}}" hero-id="{{post.id}}" on-tap="{{transition}}"></paper-icon-button>
                  </div>
                </div>
              </paper-shadow>
            </template>
          </section>

          <section>
            <paper-shadow z="2">
              <div flex vertical layout hero hero-id="{{selectedPost.id}}">
                <core-toolbar class="header-inverse tall">
                  <core-icon-button class="white-icon" icon="arrow-back" on-tap="{{transition}}"></core-icon-button>
                  <span flex>{{selectedPost.title}}</span>
                  <a href="{{selectedPost.url}}"><core-icon-button class="white-icon" icon="open-in-browser"></core-icon-button></a>
                  <time flex class="italic weight-400 middle indent" is="relative-time" datetime="{{selectedPost.published}}"></time>
                  <div class="bottom indent" horizontal layout wrap>
                    <template repeat="{{selectedPost.labels as tag}}">
                      <div class="post-tag text-subhead">{{'#' + tag}}</div>
                    </template>
                  </div>
                </core-toolbar>
              </div>  

              <div id="postHeroInsert" class="post-content"></div>
            </paper-shadow>
          </section>

        </core-animated-pages>
      </div>
    </template>

    <content></content>
  </template>
  <script>
    Polymer('blogger-page', {
      /**
       * The `blogId` attribute sets the blog to fetch data from.
       *
       * @attribute blogId
       * @type string
       * @default ''
       */
      blogId: '',

      /**
       * The `apiKey` attribute sets the apiKey for REST calls
       *
       * @attribute apiKey
       * @type string
       * @default ''
       */
      apiKey: '',

      /**
       * The `contentPreviewMaxChars` attribute sets the length for the content preview, respects word boundaries.
       *
       * @attribute contentPreviewMaxChars
       * @type int
       * @default 140
       */
      contentPreviewMaxChars: 140, // cuz twitter

      /**
       * The `maxPostCount` attribute sets the number of posts to display
       *
       * @attribute maxPostCount
       * @type int
       * @default null
       */
      maxPostCount: null,

      page: 0,

      selectedPost: null,

      htmlToTextAndTrim: function(htmlStr) {
        if (htmlStr) {
          var div = document.createElement("div");
          div.innerHTML = htmlStr;
          var text = div.textContent || div.innerText || "";
          if (text && text.length > this.contentPreviewMaxChars) {
            var trimmedString = text.substr(0, this.contentPreviewMaxChars);
            trimmedString = trimmedString.substr(0, Math.min(trimmedString.length, trimmedString.lastIndexOf(" ")))
            return trimmedString + " â€¦";
          } else {
            return text;
          }
        }
        return "";
      },

      onResponse: function(e) {
        if (this.response) {
          if (this.response.kind === 'blogger#postList' && this.response.items) {
            if (this.maxPostCount && this.response.items.length > this.maxPostCount) {
              this.posts = this.response.items.slice(0, this.maxPostCount); // remove posts
            } else {
              this.posts = this.response.items;
            }
          }
        }
      },

      transition: function(e) {
        if (this.page === 0 && e.target.templateInstance.model.post) {
          this.selectedPost = e.target.templateInstance.model.post;

          // find insertion point, remove child elements, create template, insert html
          var insertDiv = this.shadowRoot.querySelector('#postHeroInsert');
          while (insertDiv.firstChild) {
            insertDiv.removeChild(insertDiv.firstChild);
          }
          var t = document.createElement('template');
          t.innerHTML = this.selectedPost.content;
          insertDiv.appendChild(this.instanceTemplate(t));

          this.page = 1;
        } else {
          this.page = 0;
        }
      }
    });
  </script>
</polymer-element>
